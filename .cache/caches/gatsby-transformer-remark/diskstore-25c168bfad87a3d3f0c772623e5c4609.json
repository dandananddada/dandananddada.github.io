{"expireTime":9007200917962570000,"key":"transformer-remark-markdown-ast-7726924d2eeeb120b4b5acbdb7b6a616-gatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"有的时候我们在做项目的时候可能会需要软删除功能，也就是回收站机制，对于之前删除的数据可以统一在回收站进行处理恢复。Rails本身没有提供软删除的功能，所以我们需要依赖一个叫做paranoia的gems来实现该功能。","position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":1,"column":108,"offset":107},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":1,"column":108,"offset":107},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"【1】install paranoia","position":{"start":{"line":3,"column":1,"offset":109},"end":{"line":3,"column":20,"offset":128},"indent":[]}}],"position":{"start":{"line":3,"column":1,"offset":109},"end":{"line":3,"column":20,"offset":128},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在gemfile中配置paranoia插件","position":{"start":{"line":5,"column":1,"offset":130},"end":{"line":5,"column":22,"offset":151},"indent":[]}}],"position":{"start":{"line":5,"column":1,"offset":130},"end":{"line":5,"column":22,"offset":151},"indent":[]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\">#gemfile</span>\ngem <span class=\"token string\">\"paranoia\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"~> 2.0\"</span></code></pre></div>","position":{"start":{"line":7,"column":1,"offset":153},"end":{"line":10,"column":4,"offset":198},"indent":[1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"执行命令安装插件\n","position":{"start":{"line":12,"column":1,"offset":200},"end":{"line":13,"column":1,"offset":209},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ bundle install</code>","position":{"start":{"line":13,"column":1,"offset":209},"end":{"line":13,"column":19,"offset":227},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":200},"end":{"line":13,"column":19,"offset":227},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"【2】run migration for your desired models","position":{"start":{"line":15,"column":1,"offset":229},"end":{"line":15,"column":41,"offset":269},"indent":[]}}],"position":{"start":{"line":15,"column":1,"offset":229},"end":{"line":15,"column":41,"offset":269},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"运行如下命令向需要添加软删除功能的数据表添加删除时间字段\n","position":{"start":{"line":17,"column":1,"offset":271},"end":{"line":18,"column":1,"offset":300},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ rails g migration AddDeleteAtToYourModel deleted_at:datetime:index</code>","position":{"start":{"line":18,"column":1,"offset":300},"end":{"line":18,"column":71,"offset":370},"indent":[]}},{"type":"text","value":"\nRails会生成如下migration文件","position":{"start":{"line":18,"column":71,"offset":370},"end":{"line":19,"column":22,"offset":392},"indent":[1]}}],"position":{"start":{"line":17,"column":1,"offset":271},"end":{"line":19,"column":22,"offset":392},"indent":[1,1]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AddDeletedAtToYourModel</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Migration</span>\n  <span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token function\">change</span></span>\n    add_column <span class=\"token symbol\">:your_table</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:deleted_at</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:datetime</span>\n    add_index <span class=\"token symbol\">:your_table</span><span class=\"token punctuation\">,</span> <span class=\"token symbol\">:deleted_at</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>","position":{"start":{"line":21,"column":1,"offset":394},"end":{"line":28,"column":4,"offset":574},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"通过如下命令修改数据表\n","position":{"start":{"line":29,"column":1,"offset":575},"end":{"line":30,"column":1,"offset":587},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ rake db:migrate</code>","position":{"start":{"line":30,"column":1,"offset":587},"end":{"line":30,"column":20,"offset":606},"indent":[]}}],"position":{"start":{"line":29,"column":1,"offset":575},"end":{"line":30,"column":20,"offset":606},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"【3】usage","position":{"start":{"line":32,"column":1,"offset":608},"end":{"line":32,"column":9,"offset":616},"indent":[]}}],"position":{"start":{"line":32,"column":1,"offset":608},"end":{"line":32,"column":9,"offset":616},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在你需要实现软删除功能的model中添加如下语句：","position":{"start":{"line":34,"column":1,"offset":618},"end":{"line":34,"column":26,"offset":643},"indent":[]}}],"position":{"start":{"line":34,"column":1,"offset":618},"end":{"line":34,"column":26,"offset":643},"indent":[]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">YourModel</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n  <span class=\"token comment\">#for usage of softdelete</span>\n  acts_as_paranoid\n<span class=\"token keyword\">end</span></code></pre></div>","position":{"start":{"line":36,"column":1,"offset":645},"end":{"line":41,"column":4,"offset":743},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"这样当你再调用rails原生的destroy方法时，并不会直接将该id的记录从数据库中删除，而是设置该记录的删除时间为当前操作，你可以通过指定的方法显示全部删除的数据并恢复，恢复数据时paranoia会讲要恢复记录的删除时间置为空。同样针对删除的数据执行彻底删除方法时paranoia才会将这条数据从数据库移除。\n具体使用的函数如下：","position":{"start":{"line":42,"column":1,"offset":744},"end":{"line":43,"column":11,"offset":911},"indent":[1]}}],"position":{"start":{"line":42,"column":1,"offset":744},"end":{"line":43,"column":11,"offset":911},"indent":[1]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token comment\">#all records will be get.</span>\n<span class=\"token constant\">Model</span><span class=\"token punctuation\">.</span>with_deleted\n\n<span class=\"token comment\">#only deleted records will be get.</span>\n<span class=\"token constant\">Model</span><span class=\"token punctuation\">.</span>only_deleted\n\n<span class=\"token comment\">#restore specificity record by id.</span>\n<span class=\"token constant\">Model</span><span class=\"token punctuation\">.</span>restore<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#restore specificity records by id array.</span>\n<span class=\"token constant\">Model</span><span class=\"token punctuation\">.</span>restore<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>id1<span class=\"token punctuation\">,</span> id2<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">,</span> idN<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">#destroy a record from database.</span>\nmodel <span class=\"token operator\">=</span> <span class=\"token constant\">Model</span><span class=\"token punctuation\">.</span>find<span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\nmodel<span class=\"token punctuation\">.</span>really_destroy<span class=\"token operator\">!</span></code></pre></div>","position":{"start":{"line":45,"column":1,"offset":913},"end":{"line":62,"column":4,"offset":1238},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":63,"column":1,"offset":1239}}}}