{"expireTime":9007200917962570000,"key":"transformer-remark-markdown-ast-2ffc718c276402a1ccb4c1aca5c43976-gatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"一些简单的登陆注册功能可以通过普通的controller实现，相应的权限管理可以通过Session机制定义一个current_user并设置为helper来实现。当然为了更高效的开发，这里采用devise插件做权限管理。","position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":1,"column":111,"offset":110},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":1,"column":111,"offset":110},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"【1】install devise","position":{"start":{"line":3,"column":1,"offset":112},"end":{"line":3,"column":18,"offset":129},"indent":[]}}],"position":{"start":{"line":3,"column":1,"offset":112},"end":{"line":3,"column":18,"offset":129},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在Gemfile中配置devise插件","position":{"start":{"line":5,"column":1,"offset":131},"end":{"line":5,"column":20,"offset":150},"indent":[]}}],"position":{"start":{"line":5,"column":1,"offset":131},"end":{"line":5,"column":20,"offset":150},"indent":[]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">gem &#39;devise&#39;</code></pre></div>","position":{"start":{"line":7,"column":1,"offset":152},"end":{"line":7,"column":14,"offset":165},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"然后执行命令\n","position":{"start":{"line":8,"column":1,"offset":166},"end":{"line":9,"column":1,"offset":173},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ bundle install</code>","position":{"start":{"line":9,"column":1,"offset":173},"end":{"line":9,"column":19,"offset":191},"indent":[]}},{"type":"text","value":"\n这样devise就安装完成了，安装完成后需要通过如下命令进行初始化。\n","position":{"start":{"line":9,"column":19,"offset":191},"end":{"line":11,"column":1,"offset":227},"indent":[1,1]}},{"type":"html","value":"<code class=\"language-text\">$ rails g devise:install</code>","position":{"start":{"line":11,"column":1,"offset":227},"end":{"line":11,"column":27,"offset":253},"indent":[]}},{"type":"text","value":"\n然后去各个环境的配置文件中配置邮件服务器，以下以development环境为例，在config/enviroments下的development.rb文件中添加如下语句：","position":{"start":{"line":11,"column":27,"offset":253},"end":{"line":12,"column":86,"offset":339},"indent":[1]}}],"position":{"start":{"line":8,"column":1,"offset":166},"end":{"line":12,"column":86,"offset":339},"indent":[1,1,1,1]}},{"type":"html","lang":"html","value":"<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }</code></pre></div>","position":{"start":{"line":14,"column":1,"offset":341},"end":{"line":16,"column":4,"offset":429},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"【2】migrate table","position":{"start":{"line":17,"column":1,"offset":430},"end":{"line":17,"column":17,"offset":446},"indent":[]}}],"position":{"start":{"line":17,"column":1,"offset":430},"end":{"line":17,"column":17,"offset":446},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"devise安装完成后就可以自动user类了，当然这里你用来存储用户的实体也可以取其他名字，这里通常情况下就用user进行说明了。\n ","position":{"start":{"line":19,"column":1,"offset":448},"end":{"line":20,"column":2,"offset":515},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ rails g devise user</code>","position":{"start":{"line":20,"column":2,"offset":515},"end":{"line":20,"column":25,"offset":538},"indent":[]}},{"type":"text","value":"\n这个是时候devise会自动创建一些文件，其中有一个migration文件，你可以根据实际情况选取你需要的自动进行migrate。\n","position":{"start":{"line":20,"column":25,"offset":538},"end":{"line":22,"column":1,"offset":605},"indent":[1,1]}},{"type":"html","value":"<code class=\"language-text\">$ rake db:migrate</code>","position":{"start":{"line":22,"column":1,"offset":605},"end":{"line":22,"column":20,"offset":624},"indent":[]}},{"type":"text","value":"\n这样devise就会给你创建一个users表，同时你也可以使用插件提供的路由、控制器、试图使用常用的注册、登录、注销、密码找回等功能了。单多数情况我们都会在源有的基础上进行一些调整，这个时候就要用到devise的其他命令来完善路由配置、拓展方法、重写界面了。","position":{"start":{"line":22,"column":20,"offset":624},"end":{"line":23,"column":130,"offset":754},"indent":[1]}}],"position":{"start":{"line":19,"column":1,"offset":448},"end":{"line":23,"column":130,"offset":754},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"【3】configuring controller","position":{"start":{"line":25,"column":1,"offset":756},"end":{"line":25,"column":26,"offset":781},"indent":[]}}],"position":{"start":{"line":25,"column":1,"offset":756},"end":{"line":25,"column":26,"offset":781},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"对于某些controller你可能需要定制化，这里举个简单的例子，比如你的登录页面不需要继承layout，这个时候你就要再controller中配置layout false，在所难免你需要修改users_controller。这个时候就可以通过devise的命令指定要拓展的controller在其基础上进行拓展。","position":{"start":{"line":27,"column":1,"offset":783},"end":{"line":27,"column":158,"offset":940},"indent":[]}}],"position":{"start":{"line":27,"column":1,"offset":783},"end":{"line":27,"column":158,"offset":940},"indent":[]}},{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">$ rails g devise:controllers users -c=sessions</code>","position":{"start":{"line":29,"column":1,"offset":942},"end":{"line":29,"column":49,"offset":990},"indent":[]}}],"position":{"start":{"line":29,"column":1,"offset":942},"end":{"line":29,"column":49,"offset":990},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"这里我们拓展了登录模块的controller其中登录模块在devise中命名为sessions，以上命令就是将users下的sessions类拷贝到项目的app/controllers目录下，你会发现在app/controllers目录下生成一个uses目录，其中有一个sessions_controller.rb文件，这个文件中的new方法就是登录方法。我希望这个模块下不必要继承layout就做如下修改。","position":{"start":{"line":31,"column":1,"offset":992},"end":{"line":31,"column":205,"offset":1196},"indent":[]}}],"position":{"start":{"line":31,"column":1,"offset":992},"end":{"line":31,"column":205,"offset":1196},"indent":[]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">class Users::SessionsController &lt; Devise::SessionsController\n  layout false\n  #new action for login...\n  #destroy action for logout...\nend</code></pre></div>","position":{"start":{"line":32,"column":1,"offset":1197},"end":{"line":38,"column":4,"offset":1343},"indent":[1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"【4】configuring views","position":{"start":{"line":40,"column":1,"offset":1345},"end":{"line":40,"column":21,"offset":1365},"indent":[]}}],"position":{"start":{"line":40,"column":1,"offset":1345},"end":{"line":40,"column":21,"offset":1365},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"同样我需要重写login和logout的页面，这样的话我需要devise把sessions下的new.html.erb和destroy.html.erb拷贝到我的app/views目录下，执行如下命令\n","position":{"start":{"line":42,"column":1,"offset":1367},"end":{"line":43,"column":1,"offset":1468},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ rails g devise:views -v sessions</code>","position":{"start":{"line":43,"column":1,"offset":1468},"end":{"line":43,"column":37,"offset":1504},"indent":[]}},{"type":"text","value":"\n和controller类似，命令会将sessions模块的试图拷贝到app/views/devise目录下。\n当然你也可以指定模块名称创建试图：\n","position":{"start":{"line":43,"column":37,"offset":1504},"end":{"line":46,"column":1,"offset":1578},"indent":[1,1,1]}},{"type":"html","value":"<code class=\"language-text\">$ rails g devise:views users  -v sessions</code>","position":{"start":{"line":46,"column":1,"offset":1578},"end":{"line":46,"column":44,"offset":1621},"indent":[]}},{"type":"text","value":"\n这样sessions就会拷贝到app/views/users目录下，接下来你就可以重写需要定制的试图了。","position":{"start":{"line":46,"column":44,"offset":1621},"end":{"line":47,"column":53,"offset":1674},"indent":[1]}}],"position":{"start":{"line":42,"column":1,"offset":1367},"end":{"line":47,"column":53,"offset":1674},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"【5】configuring routes","position":{"start":{"line":49,"column":1,"offset":1677},"end":{"line":49,"column":22,"offset":1698},"indent":[]}}],"position":{"start":{"line":49,"column":1,"offset":1677},"end":{"line":49,"column":22,"offset":1698},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"devise默认会在你的routes文件中生成如下路由","position":{"start":{"line":51,"column":1,"offset":1700},"end":{"line":51,"column":28,"offset":1727},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":1700},"end":{"line":51,"column":28,"offset":1727},"indent":[]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">devise_for <span class=\"token symbol\">:users</span></code></pre></div>","position":{"start":{"line":53,"column":1,"offset":1729},"end":{"line":55,"column":4,"offset":1758},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"你可以通过","position":{"start":{"line":57,"column":1,"offset":1760},"end":{"line":57,"column":6,"offset":1765},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">$ rake routes</code>","position":{"start":{"line":57,"column":6,"offset":1765},"end":{"line":57,"column":21,"offset":1780},"indent":[]}},{"type":"text","value":"查看其对应的路由都有哪些，这里以登录注销为例自动生成的路由为users/sgin","position":{"start":{"line":57,"column":21,"offset":1780},"end":{"line":57,"column":61,"offset":1820},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"in和users/sgin","position":{"start":{"line":57,"column":62,"offset":1821},"end":{"line":57,"column":75,"offset":1834},"indent":[]}}],"position":{"start":{"line":57,"column":61,"offset":1820},"end":{"line":57,"column":76,"offset":1835},"indent":[]}},{"type":"text","value":"out。\n如果你想重命名路由，同时你又修改了路由对应的action，这个时候你就需要配置routes下的devise_for路由了。","position":{"start":{"line":57,"column":76,"offset":1835},"end":{"line":58,"column":62,"offset":1901},"indent":[1]}}],"position":{"start":{"line":57,"column":1,"offset":1760},"end":{"line":58,"column":62,"offset":1901},"indent":[1]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">devise_for :users, controllers: { sessions: &quot;users/sessions&quot; }, path: &quot;&quot;, path_names: { sign_in: &#39;login&#39;, sign_out: &#39;logout&#39;, registration: &#39;register&#39; }</code></pre></div>","position":{"start":{"line":60,"column":1,"offset":1903},"end":{"line":62,"column":4,"offset":2063},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"如上配置users路由sessions模块对应的controller是users/sessions","position":{"start":{"line":64,"column":1,"offset":2065},"end":{"line":64,"column":50,"offset":2114},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"controller.rb文件，同时重命名登录路由sign","position":{"start":{"line":64,"column":51,"offset":2115},"end":{"line":64,"column":80,"offset":2144},"indent":[]}}],"position":{"start":{"line":64,"column":50,"offset":2114},"end":{"line":64,"column":81,"offset":2145},"indent":[]}},{"type":"text","value":"in为login，sign","position":{"start":{"line":64,"column":81,"offset":2145},"end":{"line":64,"column":94,"offset":2158},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"out为logout，并且我这里path设置为空，也就是说最初的user/sign","position":{"start":{"line":64,"column":95,"offset":2159},"end":{"line":64,"column":136,"offset":2200},"indent":[]}}],"position":{"start":{"line":64,"column":94,"offset":2158},"end":{"line":64,"column":137,"offset":2201},"indent":[]}},{"type":"text","value":"in路由最终重命名为login。","position":{"start":{"line":64,"column":137,"offset":2201},"end":{"line":64,"column":153,"offset":2217},"indent":[]}}],"position":{"start":{"line":64,"column":1,"offset":2065},"end":{"line":64,"column":153,"offset":2217},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"【6】adjust your controller","position":{"start":{"line":66,"column":1,"offset":2219},"end":{"line":66,"column":26,"offset":2244},"indent":[]}}],"position":{"start":{"line":66,"column":1,"offset":2219},"end":{"line":66,"column":26,"offset":2244},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"这里针对一些路由需要权限配置，未登录用户是无法访问的，你可以在需要权限控制的controller中添加如下语句：","position":{"start":{"line":68,"column":1,"offset":2246},"end":{"line":68,"column":57,"offset":2302},"indent":[]}}],"position":{"start":{"line":68,"column":1,"offset":2246},"end":{"line":68,"column":57,"offset":2302},"indent":[]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\">before_action <span class=\"token symbol\">:authenticate_user!</span></code></pre></div>","position":{"start":{"line":70,"column":1,"offset":2304},"end":{"line":72,"column":4,"offset":2349},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"这里我新建一个auth_controller用于做权限控制，所有需要登录权限的模块默认继承ApplicationController修改为AuthController，并将devise自动填充到ApplicationController中的代码集成到AuthController中，最后AuthController代码如下：","position":{"start":{"line":73,"column":1,"offset":2350},"end":{"line":73,"column":163,"offset":2512},"indent":[]}}],"position":{"start":{"line":73,"column":1,"offset":2350},"end":{"line":73,"column":163,"offset":2512},"indent":[]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthController</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ApplicationController</span>\n \tprotect_from_forgery with<span class=\"token punctuation\">:</span> <span class=\"token symbol\">:exception</span>\n \tbefore_action <span class=\"token symbol\">:authenticate_user!</span>\n<span class=\"token keyword\">end</span></code></pre></div>","position":{"start":{"line":75,"column":1,"offset":2514},"end":{"line":80,"column":4,"offset":2650},"indent":[1,1,1,1,1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":82,"column":1,"offset":2652}}}}