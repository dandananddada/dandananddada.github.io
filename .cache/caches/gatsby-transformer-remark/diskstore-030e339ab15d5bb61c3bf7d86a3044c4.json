{"expireTime":9007200917962570000,"key":"transformer-remark-markdown-ast-b4270011eb167490b4833ed2836bc0bf-gatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"rails本身文件/图片上传的函数是很方便快捷的，但是很多情况下我们可能需要对上传的图片进行必要的操作，比如对图像resize、限制格式、大小等。\n这里介绍一个常用的第三方插件paperclip。","position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":2,"column":25,"offset":98},"indent":[1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":2,"column":25,"offset":98},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"【1】install paperclip","position":{"start":{"line":4,"column":1,"offset":100},"end":{"line":4,"column":21,"offset":120},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":100},"end":{"line":4,"column":21,"offset":120},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在Gemfile中配置paperclip插件","position":{"start":{"line":6,"column":1,"offset":122},"end":{"line":6,"column":23,"offset":144},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":122},"end":{"line":6,"column":23,"offset":144},"indent":[]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">gem &#39;paperclip&#39;</code></pre></div>","position":{"start":{"line":8,"column":1,"offset":146},"end":{"line":8,"column":17,"offset":162},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"然后执行命令\n","position":{"start":{"line":10,"column":1,"offset":164},"end":{"line":11,"column":1,"offset":171},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ bundle install</code>","position":{"start":{"line":11,"column":1,"offset":171},"end":{"line":11,"column":19,"offset":189},"indent":[]}},{"type":"text","value":"\n这样paperclip就安装成功了。","position":{"start":{"line":11,"column":19,"offset":189},"end":{"line":12,"column":19,"offset":208},"indent":[1]}}],"position":{"start":{"line":10,"column":1,"offset":164},"end":{"line":12,"column":19,"offset":208},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"【2】Add column to your table","position":{"start":{"line":14,"column":1,"offset":210},"end":{"line":14,"column":28,"offset":237},"indent":[]}}],"position":{"start":{"line":14,"column":1,"offset":210},"end":{"line":14,"column":28,"offset":237},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"paperclip会在你需要图片支持的模块所对应的数据库表中添加四个字段，这个时候你需要在命令行中执行命令创建这个migration。\n假设我们在user表中添加一个avatar属性用来存用户图像，那么命令如下:\n","position":{"start":{"line":16,"column":1,"offset":239},"end":{"line":18,"column":1,"offset":346},"indent":[1,1]}},{"type":"html","value":"<code class=\"language-text\">$ rails g paperclip user avatar</code>","position":{"start":{"line":18,"column":1,"offset":346},"end":{"line":18,"column":34,"offset":379},"indent":[]}},{"type":"text","value":"\n观察migration文件会有这么一段代码","position":{"start":{"line":18,"column":34,"offset":379},"end":{"line":19,"column":22,"offset":401},"indent":[1]}}],"position":{"start":{"line":16,"column":1,"offset":239},"end":{"line":19,"column":22,"offset":401},"indent":[1,1,1]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">def</span> <span class=\"token method-definition\"><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span><span class=\"token function\">up</span></span>\n  change_table <span class=\"token symbol\">:users</span> <span class=\"token keyword\">do</span> <span class=\"token operator\">|</span>t<span class=\"token operator\">|</span>\n    t<span class=\"token punctuation\">.</span>attachment <span class=\"token symbol\">:avatar</span>\n  <span class=\"token keyword\">end</span>\n<span class=\"token keyword\">end</span></code></pre></div>","position":{"start":{"line":21,"column":1,"offset":403},"end":{"line":27,"column":4,"offset":490},"indent":[1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"命令行migrate数据库\n","position":{"start":{"line":28,"column":1,"offset":491},"end":{"line":29,"column":1,"offset":505},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$rake db:migrate</code>","position":{"start":{"line":29,"column":1,"offset":505},"end":{"line":29,"column":19,"offset":523},"indent":[]}},{"type":"text","value":"\npaperclip会在users表中添加如下四个字段：\n\t\t\n\tavatar","position":{"start":{"line":29,"column":19,"offset":523},"end":{"line":32,"column":8,"offset":562},"indent":[1,1,1]}},{"type":"emphasis","children":[{"type":"text","value":"file","position":{"start":{"line":32,"column":9,"offset":563},"end":{"line":32,"column":13,"offset":567},"indent":[]}}],"position":{"start":{"line":32,"column":8,"offset":562},"end":{"line":32,"column":14,"offset":568},"indent":[]}},{"type":"text","value":"name（图片名称）、avatar","position":{"start":{"line":32,"column":14,"offset":568},"end":{"line":32,"column":31,"offset":585},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"content","position":{"start":{"line":32,"column":32,"offset":586},"end":{"line":32,"column":39,"offset":593},"indent":[]}}],"position":{"start":{"line":32,"column":31,"offset":585},"end":{"line":32,"column":40,"offset":594},"indent":[]}},{"type":"text","value":"type（图片类型）、avatar","position":{"start":{"line":32,"column":40,"offset":594},"end":{"line":32,"column":57,"offset":611},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"file","position":{"start":{"line":32,"column":58,"offset":612},"end":{"line":32,"column":62,"offset":616},"indent":[]}}],"position":{"start":{"line":32,"column":57,"offset":611},"end":{"line":32,"column":63,"offset":617},"indent":[]}},{"type":"text","value":"size（图片大小）、avatar","position":{"start":{"line":32,"column":63,"offset":617},"end":{"line":32,"column":80,"offset":634},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"updated","position":{"start":{"line":32,"column":81,"offset":635},"end":{"line":32,"column":88,"offset":642},"indent":[]}}],"position":{"start":{"line":32,"column":80,"offset":634},"end":{"line":32,"column":89,"offset":643},"indent":[]}},{"type":"text","value":"at（图片更新日期）","position":{"start":{"line":32,"column":89,"offset":643},"end":{"line":32,"column":99,"offset":653},"indent":[]}}],"position":{"start":{"line":28,"column":1,"offset":491},"end":{"line":32,"column":99,"offset":653},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在app/models/user.rb下添加属性","position":{"start":{"line":34,"column":1,"offset":655},"end":{"line":34,"column":25,"offset":679},"indent":[]}}],"position":{"start":{"line":34,"column":1,"offset":655},"end":{"line":34,"column":25,"offset":679},"indent":[]}},{"type":"html","lang":"ruby","value":"<div class=\"gatsby-highlight\" data-language=\"ruby\"><pre class=\"language-ruby\"><code class=\"language-ruby\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span> <span class=\"token operator\">&lt;</span> <span class=\"token constant\">ActiveRecord</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">Base</span>\n\thas_attached_file <span class=\"token symbol\">:avatar</span><span class=\"token punctuation\">,</span> \n\t\t\tstyles<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> small<span class=\"token punctuation\">:</span> <span class=\"token string\">\"150x150>\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\t\t\turl<span class=\"token punctuation\">:</span> <span class=\"token string\">\"/uploads/articles/:id/:style/:basename.:extension\"</span><span class=\"token punctuation\">,</span>\n\t\t\tpath<span class=\"token punctuation\">:</span> <span class=\"token string\">\":rails_root/public/uploads/articles/:id/:style/:basename.:extension\"</span>\n\tvalidates_attachment <span class=\"token symbol\">:avatar</span><span class=\"token punctuation\">,</span> content_type<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span> content_type<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"image/jpg\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"image/jpeg\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"image/gif\"</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">end</span></code></pre></div>","position":{"start":{"line":36,"column":1,"offset":681},"end":{"line":44,"column":4,"offset":1047},"indent":[1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"其中has","position":{"start":{"line":45,"column":1,"offset":1048},"end":{"line":45,"column":6,"offset":1053},"indent":[]}},{"type":"emphasis","children":[{"type":"text","value":"attached","position":{"start":{"line":45,"column":7,"offset":1054},"end":{"line":45,"column":15,"offset":1062},"indent":[]}}],"position":{"start":{"line":45,"column":6,"offset":1053},"end":{"line":45,"column":16,"offset":1063},"indent":[]}},{"type":"text","value":"file用来配置图片缩放尺寸、逻辑存储路径、物理存储路径。validates_attachment用来配置上传图片的类型、大小等，更多配置可以参考github","position":{"start":{"line":45,"column":16,"offset":1063},"end":{"line":45,"column":95,"offset":1142},"indent":[]}}],"position":{"start":{"line":45,"column":1,"offset":1048},"end":{"line":45,"column":95,"offset":1142},"indent":[]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://github.com/thoughtbot/paperclip</code></pre></div>","position":{"start":{"line":47,"column":1,"offset":1144},"end":{"line":48,"column":2,"offset":1186},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"【3】final work","position":{"start":{"line":49,"column":1,"offset":1187},"end":{"line":49,"column":14,"offset":1200},"indent":[]}}],"position":{"start":{"line":49,"column":1,"offset":1187},"end":{"line":49,"column":14,"offset":1200},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"剩下的就是在views和controller中做一些必要的代码处理了。\n在app/views/users/","position":{"start":{"line":51,"column":1,"offset":1202},"end":{"line":52,"column":18,"offset":1255},"indent":[1]}},{"type":"emphasis","children":[{"type":"text","value":"form.html.erb中做如下修改。\n因为涉及文件上传，所以要修改表单属性，设置","position":{"start":{"line":52,"column":19,"offset":1256},"end":{"line":53,"column":22,"offset":1298},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">enctype=&quot;multipart/form-data&quot;。</code>","position":{"start":{"line":53,"column":22,"offset":1298},"end":{"line":53,"column":54,"offset":1330},"indent":[]}},{"type":"text","value":"\n{% highlight ruby %}\n<%= form","position":{"start":{"line":53,"column":54,"offset":1330},"end":{"line":55,"column":9,"offset":1360},"indent":[1,1]}}],"position":{"start":{"line":52,"column":18,"offset":1255},"end":{"line":55,"column":10,"offset":1361},"indent":[1,1,1]}},{"type":"text","value":"for(@user, html: { multipart: true }) do |f| %>\n{% endhighlight %}\n添加","position":{"start":{"line":55,"column":10,"offset":1361},"end":{"line":57,"column":3,"offset":1430},"indent":[1,1]}},{"type":"html","value":"<code class=\"language-text\">&lt;input type=&quot;file&quot; /&gt;</code>","position":{"start":{"line":57,"column":3,"offset":1430},"end":{"line":57,"column":26,"offset":1453},"indent":[]}},{"type":"text","value":"节点。名称为User中的属性avatar。","position":{"start":{"line":57,"column":26,"offset":1453},"end":{"line":57,"column":47,"offset":1474},"indent":[]}}],"position":{"start":{"line":51,"column":1,"offset":1202},"end":{"line":57,"column":47,"offset":1474},"indent":[1,1,1,1,1,1]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;%= f.file_field :avatar %&gt;</code></pre></div>","position":{"start":{"line":59,"column":1,"offset":1476},"end":{"line":61,"column":4,"offset":1511},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"最后在app/controllers/users_controller.rb中设置通过avatar字段的验证","position":{"start":{"line":62,"column":1,"offset":1512},"end":{"line":62,"column":55,"offset":1566},"indent":[]}}],"position":{"start":{"line":62,"column":1,"offset":1512},"end":{"line":62,"column":55,"offset":1566},"indent":[]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> params.require(:user).permit(:username, :age, :avatar)</code></pre></div>","position":{"start":{"line":64,"column":1,"offset":1568},"end":{"line":66,"column":4,"offset":1631},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"这样paperclip就会自动维护数据中的四个字段，并且在配置的目录存储图片。\n当你需要显示图片的时候在app/views/users/show.html.erb中添加如下代码：","position":{"start":{"line":67,"column":1,"offset":1632},"end":{"line":68,"column":50,"offset":1721},"indent":[1]}}],"position":{"start":{"line":67,"column":1,"offset":1632},"end":{"line":68,"column":50,"offset":1721},"indent":[1]}},{"type":"html","lang":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&lt;%= image_tag @user.photo.url(:small) %&gt;</code></pre></div>","position":{"start":{"line":70,"column":1,"offset":1723},"end":{"line":72,"column":4,"offset":1771},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"其中:small是你在models中配置的一种图片尺寸，你也可以配置多种，或者直接通过","position":{"start":{"line":73,"column":1,"offset":1772},"end":{"line":73,"column":44,"offset":1815},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">image_tag @message.photo.url</code>","position":{"start":{"line":73,"column":44,"offset":1815},"end":{"line":73,"column":74,"offset":1845},"indent":[]}},{"type":"text","value":"显示原尺寸的图片。\n最后这里说一点，paperclip本身图片的处理功能是借助ImageMagick实现的，所以你需要安装ImageMagick。\nMac下命令：","position":{"start":{"line":73,"column":74,"offset":1845},"end":{"line":75,"column":8,"offset":1926},"indent":[1,1]}},{"type":"html","value":"<code class=\"language-text\">$ brew install ImageMagick</code>","position":{"start":{"line":75,"column":8,"offset":1926},"end":{"line":75,"column":36,"offset":1954},"indent":[]}},{"type":"text","value":"\nLinux下命令：","position":{"start":{"line":75,"column":36,"offset":1954},"end":{"line":76,"column":10,"offset":1964},"indent":[1]}},{"type":"html","value":"<code class=\"language-text\">$ apt-get install ImageMagick</code>","position":{"start":{"line":76,"column":10,"offset":1964},"end":{"line":76,"column":41,"offset":1995},"indent":[]}}],"position":{"start":{"line":73,"column":1,"offset":1772},"end":{"line":76,"column":41,"offset":1995},"indent":[1,1,1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":77,"column":1,"offset":1996}}}}