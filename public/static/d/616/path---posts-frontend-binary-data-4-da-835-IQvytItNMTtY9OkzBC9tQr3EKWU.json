{"data":{"markdownRemark":{"html":"<h2>ArrayBuffer, binary arrays</h2>\n<h3>ArrayBuffer</h3>\n<p>Binary data in JavaScript is implemented in a non-standard way, compared to other languages. But when we sort things out, everything becomes fairly simple.</p>\n<p>The basic binary object is ArrayBuffer – a reference to a fixed-length contiguous memory area.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayBuffer</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span>byteLength<span class=\"token punctuation\">)</span></code></pre></div>\n<p>ArrayBuffer is not an array of something</p>\n<ul>\n<li>It has a fixed length, we can’t increase or decrease it.</li>\n<li>It takes exactly that much space in the memory.</li>\n<li>To access individual bytes, another \"view\" object is needed, not <code class=\"language-text\">buffer[index]</code>.</li>\n</ul>\n<p>To manipulate an ArrayBuffer, we need to use a \"view\" object.</p>\n<p>A view object does not store anything on it’s own. It’s the \"eyeglasses\" that give an interpretation of the bytes stored in the ArrayBuffer.</p>\n<ul>\n<li><strong>Uint8Array</strong> – treats each byte in ArrayBuffer as a separate number, with possible values are from 0 to 255 (a byte is 8-bit, so it can hold only that much).</li>\n<li><strong>Uint16Array</strong> – treats every 2 bytes as an integer, with possible values from 0 to 65535.</li>\n<li><strong>Uint32Array</strong> – treats every 4 bytes as an integer, with possible values from 0 to 4294967295.</li>\n<li><strong>Float64Array</strong> – treats every 8 bytes as a floating point number with possible values from 5.0x10<sup>-324</sup> to 1.8x10<sup>308</sup>.</li>\n</ul>\n<p>So, the binary data in an ArrayBuffer of 16 bytes can be interpreted as 16 \"tiny numbers\", or 8 bigger numbers (2 bytes each), or 4 even bigger (4 bytes each), or 2 floating-point values with high precision (8 bytes each).</p>\n<p><img src=\"https://javascript.info/article/arraybuffer-binary-arrays/arraybuffer-views@2x.png\"></p>\n<p>But if we’re going to write into it, or iterate over it, basically for almost any operation – we must use a view.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayBuffer</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> view <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint32Array</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 4</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>view<span class=\"token punctuation\">.</span>byteLength<span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 16</span>\n\n\nview<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">1234</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> num <span class=\"token keyword\">of</span> view<span class=\"token punctuation\">)</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>num<span class=\"token punctuation\">)</span>\n<span class=\"token comment\">/*\n * 1234\n * 0\n * 0\n * 0\n*/</span></code></pre></div>\n<h3>TypedArray</h3>\n<p>The common term for all these views (Uint8Array, Uint32Array, etc) is TypedArray. They share the same set of methods and properities.</p>\n<p>They are much more like regular arrays: have indexes and iterable.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> arr16 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint16Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> arr8 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>arr16<span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>arr16<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>arr16<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>arr8<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>arr8<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">// 232, tried to copy 1000, but can't fit 1000 into 8 bits (explanations below)</span></code></pre></div>\n<p>To access the ArrayBuffer, there are properties:</p>\n<ul>\n<li><code class=\"language-text\">arr.buffer</code> – references the ArrayBuffer.</li>\n<li><code class=\"language-text\">arr.byteLength</code> – the length of the ArrayBuffer.</li>\n</ul>\n<h4>Out-of-bounds behavior</h4>\n<p>What if we attempt to write an out-of-bounds value into a typed array? There will be no error. But extra bits are cut-off.</p>\n<p>For bigger numbers, only the rightmost (less significant) 8 bits are stored, and the rest is cut off:</p>\n<img src=\"https://javascript.info/article/arraybuffer-binary-arrays/8bit-integer-256@2x.png\" width=\"160px\">\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> num <span class=\"token operator\">=</span> <span class=\"token number\">256</span>\nnum<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 100000000</span>\n\n<span class=\"token keyword\">let</span> uint8array <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token number\">16</span><span class=\"token punctuation\">)</span>\nuint8array<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">256</span>\nuint8array<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">257</span>\n\nuint8array<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\">// 0</span>\nuint8array<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\">// 1</span></code></pre></div>\n<h4>TypedArray methods</h4>\n<p>TypedArray has regular Array methods, with notable exceptions.</p>\n<p>We can <code class=\"language-text\">iterate</code>, <code class=\"language-text\">map</code>, <code class=\"language-text\">slice</code>, <code class=\"language-text\">find</code>, <code class=\"language-text\">reduce</code> etc.</p>\n<ul>\n<li>No <code class=\"language-text\">splice</code> – we can’t delete a value, because typed arrays are views on a buffer, and these are fixed.</li>\n<li>No <code class=\"language-text\">concat</code> method.</li>\n</ul>\n<p>There are two additional methods:</p>\n<ul>\n<li><code class=\"language-text\">arr.set(fromArr, [offset])</code> copies all elements from fromArr to the arr, starting at position offset (0 by default).</li>\n<li><code class=\"language-text\">arr.subarray([begin, end])</code> creates a new view of the same type from begin to end. That’s similar to slice. </li>\n</ul>\n<h3>DataView</h3>\n<p>DataView is a special super-flexible \"untyped\" view over ArrayBuffer. It allows to access the data on any offset in any format.</p>\n<ul>\n<li>For typed arrays, the constructor dictates what the format is. The whole array is supposed to be uniform.</li>\n<li>With DataView we access the data with methods like <code class=\"language-text\">getUint8(i)</code> or <code class=\"language-text\">getUint16(i)</code>. We choose the format at method call time instead of the construction time.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> buffer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">255</span><span class=\"token punctuation\">,</span> <span class=\"token number\">256</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> dataView <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">DataView</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ndataView<span class=\"token punctuation\">.</span><span class=\"token function\">getUint8</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\ndataView<span class=\"token punctuation\">.</span><span class=\"token function\">getUint8</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// out of bound</span>\ndataView<span class=\"token punctuation\">.</span><span class=\"token function\">getUint16</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// now get 16-bit number at offset 0, it consists of 2 bytes, together iterpreted as 65535</span></code></pre></div>\n<br>\n<h2>TextDecoder and TextEncoder</h2>\n<h3>TextDecoder</h3>\n<p>The build-in TextDecoder object allows to read the value into an actual JavaScript string, given the buffer and the encoding.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> uint8Array <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">72</span><span class=\"token punctuation\">,</span> <span class=\"token number\">101</span><span class=\"token punctuation\">,</span> <span class=\"token number\">108</span><span class=\"token punctuation\">,</span> <span class=\"token number\">108</span><span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>uint8Array<span class=\"token punctuation\">)</span> <span class=\"token comment\">// Hello</span>\n\n<span class=\"token keyword\">let</span> uint8Array <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">228</span><span class=\"token punctuation\">,</span> <span class=\"token number\">189</span><span class=\"token punctuation\">,</span> <span class=\"token number\">160</span><span class=\"token punctuation\">,</span> <span class=\"token number\">229</span><span class=\"token punctuation\">,</span> <span class=\"token number\">165</span><span class=\"token punctuation\">,</span> <span class=\"token number\">189</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">TextDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>uint8Array<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 你好</span></code></pre></div>\n<h3>TextEncoder</h3>\n<p>TextEncoder does the reverse thing – converts a string into bytes.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> encoder <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TextEncoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> uint8Array <span class=\"token operator\">=</span> encoder<span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hello\"</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>uint8Array<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 72,101,108,108,111</span></code></pre></div>\n<br>\n<h2>Blob</h2>\n<p>ArrayBuffer and views are a part of ECMA standard, a part of JavaScript.\nIn the browser, there are additional higher-level objects, described in File API, in particular <code class=\"language-text\">Blob</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// create Blob from a string</span>\n<span class=\"token keyword\">let</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"&lt;html>…&lt;/html>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>type<span class=\"token punctuation\">:</span> <span class=\"token string\">'text/html'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\">// create Blob from a typed array and strings</span>\n<span class=\"token keyword\">let</span> hello <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">72</span><span class=\"token punctuation\">,</span> <span class=\"token number\">101</span><span class=\"token punctuation\">,</span> <span class=\"token number\">108</span><span class=\"token punctuation\">,</span> <span class=\"token number\">108</span><span class=\"token punctuation\">,</span> <span class=\"token number\">111</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">let</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>hello<span class=\"token punctuation\">,</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'world'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>type<span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>Blobs are immutable</strong>\nWe can’t change data directly in a blob, but we can slice parts of blobs, create new blobs from them, mix them into a new blob and so on.\n</p>\n<h3>Blob as URL</h3>\n<p>A Blob can be easily used as an URL for <code class=\"language-text\">&lt;a&gt;</code>, <code class=\"language-text\">&lt;img&gt;</code> or other tags, to show its contents.</p>\n<p>Thanks to type, we can allso download/upload blobs, and it naturally becomes <code class=\"language-text\">Content-Type</code> in network requests.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nlink<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'hello.txt'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Hello, world!'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>type<span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nlink<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nlink<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">revokeObjectURL</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>That’s what the value of link.href looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">blob:https://javascript.info/1e67e00e-860d-40a5-89ae-6ab0cbee6273</code></pre></div>\n<p>If we create an URL, that blob will hang in memory, even if not needed any more. So <code class=\"language-text\">URL.revokeObjectURL(url)</code> removes the reference from the internal mapping, thus allowing the blob to be deleted (if there are no other references), and the memory to be freed.</p>\n<h3>Blob to base64</h3>\n<p>An alternative to<code class=\"language-text\">URL.createObjectURL</code> is to convert a blob into a base64-encoded string.</p>\n<p>Here’s the demo of downloading a blob, now via base-64:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nlink<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'hello.txt'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Blob</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'Hello, world!'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>type<span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nreader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsDataURL</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// converts the blob to base64 and calls onload</span>\n\nreader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  link<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">;</span> <span class=\"token comment\">// data url</span>\n  link<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Both ways of making an URL of a blob are usable. But usually <code class=\"language-text\">URL.createObjectURL(blob)</code> is simpler and faster.</p>\n<p><strong>URL.createObjectURL(blob)</strong></p>\n<ul>\n<li>We need to revoke them if care about memory.</li>\n<li>Direct access to blob, no “encoding/decoding”</li>\n</ul>\n<p><strong>Blob to data url</strong></p>\n<ul>\n<li>No need to revoke anything.</li>\n<li>Performance and memory losses on big blobs for encoding.</li>\n</ul>\n<h3>Image to blob</h3>\n<p>We can create a blob of an image. Image operations are done via <code class=\"language-text\">&lt;canvas&gt;</code> element:</p>\n<ol>\n<li>Draw an image (or its part) on canvas using canvas.drawImage.</li>\n<li>Call canvas method <code class=\"language-text\">toBlob(callback, format, quality)</code> that creates a blob and runs callback with it when done.</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">canvas<span class=\"token punctuation\">.</span><span class=\"token function\">toBlob</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">blob</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// blob ready, download it</span>\n  <span class=\"token keyword\">let</span> link <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  link<span class=\"token punctuation\">.</span>download <span class=\"token operator\">=</span> <span class=\"token string\">'example.png'</span><span class=\"token punctuation\">;</span>\n\n  link<span class=\"token punctuation\">.</span>href <span class=\"token operator\">=</span> <span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">createObjectURL</span><span class=\"token punctuation\">(</span>blob<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  link<span class=\"token punctuation\">.</span><span class=\"token function\">click</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// delete the internal blob reference, to let the browser clear memory from it</span>\n  <span class=\"token constant\">URL</span><span class=\"token punctuation\">.</span><span class=\"token function\">revokeObjectURL</span><span class=\"token punctuation\">(</span>link<span class=\"token punctuation\">.</span>href<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'image/png'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>If we prefer async/await instead of callbacks:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> blob <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> canvasElem<span class=\"token punctuation\">.</span><span class=\"token function\">toBlob</span><span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">,</span> <span class=\"token string\">'image/png'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>Summary of Blob</h3>\n<p>While <code class=\"language-text\">ArrayBuffer</code>, <code class=\"language-text\">Uint8Array</code> and other <code class=\"language-text\">BufferSource</code> are \"binary data\", a Blob represents \"binary data with type\".</p>\n<p>That makes Blobs convenient for upload/download operations, that are so common in the browser.</p>\n<p>We can easily convert betweeen Blob and low-level binary data types:</p>\n<ul>\n<li>We can make a Blob from a typed array using <code class=\"language-text\">new Blob(...)</code> constructor.</li>\n<li>We can get back ArrayBuffer from a Blob using <code class=\"language-text\">FileReader</code>, and then create a view over it for low-level binary processing.</li>\n</ul>\n<br>\n<h2>File and FileReader</h2>\n<p>A File object inherits from Blob and is extended with filesystem-related capabilities.</p>\n<p>There are two ways to obtain it.</p>\n<ul>\n<li>First, there’s a constructor, similar to Blob.</li>\n<li>Second, more often we get a file from <code class=\"language-text\">&lt;input type=&quot;file&quot;&gt;</code>.</li>\n</ul>\n<h3>FileReader</h3>\n<p>FileReader is an object with the sole purpose of reading data from Blob (and hence File too) objects. It delivers the data using events, as reading from disk may take time.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h4>The main methods</h4>\n<table>\n<thead>\n<tr>\n<th align=\"center\">name</th>\n<th align=\"center\">descripition</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\"><code class=\"language-text\">readAsArrayBuffer(blob)</code></td>\n<td align=\"center\">read the data in binary format ArrayBuffer.</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">readAsText(blob, [encoding])</code></td>\n<td align=\"center\">read the data as a text string with the given encoding</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">readAsDataURL(blob)</code></td>\n<td align=\"center\">read the binary data and encode it as base64 data url</td>\n</tr>\n<tr>\n<td align=\"center\"><code class=\"language-text\">abort()</code></td>\n<td align=\"center\">cancel the operation</td>\n</tr>\n</tbody>\n</table>\n<p>As the reading proceeds, there are events:</p>\n<ul>\n<li><code class=\"language-text\">loadstart</code> – loading started.</li>\n<li><code class=\"language-text\">progress</code> – occurs during reading.</li>\n<li><code class=\"language-text\">load</code> – no errors, reading complete.</li>\n<li><code class=\"language-text\">abort</code> – abort called.</li>\n<li><code class=\"language-text\">error</code> – error has occurred.</li>\n<li><code class=\"language-text\">loadend</code> – reading finished with either success or failure.</li>\n</ul>\n<p>When the reading is finished, we can access the result as:</p>\n<ul>\n<li><code class=\"language-text\">reader.result</code> is the result (if successful).</li>\n<li><code class=\"language-text\">reader.error</code> is the error (if failed).</li>\n</ul>\n<p>Here’s an example of reading a file:</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">onchange</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>readFile(this)<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n<span class=\"token keyword\">function</span> <span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">input</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> file <span class=\"token operator\">=</span> input<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">let</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsText</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onerror</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>reader<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<h4>FileReader for blobs</h4>\n<p>FileReader can read not just files, but any blobs. We can use it to convert a blob to another format:</p>\n<ul>\n<li><code class=\"language-text\">readAsArrayBuffer(blob)</code> – to ArrayBuffer.</li>\n<li><code class=\"language-text\">readAsText(blob, [encoding])</code> – to string (an alternative to TextDecoder).</li>\n<li><code class=\"language-text\">readAsDataURL(blob)</code> – to base64 data url.</li>\n</ul>\n<h4>FileReaderSync is available inside Web Workers</h4>\n<p>For Web Workers, there also exists a synchronous variant of FileReader, called FileReaderSync.</p>\n<p><strong>In many cases though, we don’t have to read the file contents</strong>. Just as we did with blobs, we can create a short url with <code class=\"language-text\">URL.createObjectURL(file)</code> and assign it to <code class=\"language-text\">&lt;a&gt;</code> or <code class=\"language-text\">&lt;img&gt;</code>.</p>\n<p>This way the file can be downloaded or shown up as an image, as a part of canvas etc. And if we’re going to send a File over a network, that’s also easy: network API like <code class=\"language-text\">XMLHttpRequest</code> or <code class=\"language-text\">fetch</code> natively accepts File objects.</p>\n<h2>Resources</h2>\n<p>(<a href=\"https://javascript.info/binary\">https://javascript.info/binary</a>)[Binary data, files] - javascript.info</p>","frontmatter":{"date":"July 08, 2019","path":"binary-data","category":"frontend","title":"Binary Data"}}},"pageContext":{"location":"binary-data","category":"frontend"}}